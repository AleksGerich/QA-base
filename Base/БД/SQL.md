---
tags:
---

---
#sql_факты
# SQL общие аспекты

 **`=`** используется для точного совпадения, а **`LIKE`** — для поиска по шаблону в строках

### Порядок написания запроса SQL:
1. SELECT
2. FROM
3. WHERE
4. GROUP BY
5. HAVING
6. ORDER BY
### Порядок выполнения запроса SQL:
1. FROM
2. WHERE
3. GROUP BY
4. HAVING
5. SELECT
6. ORDER BY

![[Pasted image 20241125102914.png]]

***JDBC (DriverManager.getConnection)*** - библиотека Java для взаимодействия сервера с БД

---
#Функции 
# SQL функции

### 1. Агрегатные функции

Выполняют вычисления над набором строк и возвращают одно значение. Они обычно используются в комбинации с оператором `GROUP BY` для выполнения групповых операций
	
- **`COUNT()`** — подсчитывает количество строк.
- **`SUM()`** — вычисляет сумму значений.
- **`AVG()`** — вычисляет среднее значение.
- **`MAX()`** и **`MIN()`** — находят максимальное и минимальное значение соответственно.

### 2. Скалярные функции

Принимают одно или несколько значений и возвращают одно значение.
	
- **Строковые функции**:
    - **`UPPER()`** / **`LOWER()`** — перевод текста в верхний или нижний регистр.
    - **`SUBSTRING()`** — возвращает часть строки.
    - **`LENGTH()`** — возвращает длину строки.
- **Математические функции**:
    - **`ABS()`** — возвращает модуль числа.
    - **`ROUND()`** — округляет число до указанного количества знаков.
    - **`SQRT()`** — вычисляет квадратный корень.
- **Функции работы с датами**:
    - **`NOW()`** — возвращает текущую дату и время.
    - **`DATEADD()`** — добавляет указанное количество времени к дате.
    - **`DATEDIFF()`** — вычисляет разницу между двумя датами.

### 3. Пользовательские функции (UDF - User-Defined Functions)

Функции, которые пользователь может создавать самостоятельно для выполнения специфических операций. Они могут принимать параметры и возвращать значения, что делает их удобными для повторного использования.

**Пользовательские функции могут быть:**
- **детерминированными** (результат всегда один и тот же для одинаковых входных данных)
- **недетерминированными** (результат может меняться при каждом выполнении)

*@:*
*CREATE FUNCTION get_full_name(first_name VARCHAR(50), last_name VARCHAR(50)) RETURNS VARCHAR(100)* 
*BEGIN* 
	*RETURN CONCAT(first_name, ' ', last_name);* 
*END;*

### 4. Конвертирующие функции

Преобразуют данные из одного типа в другой
	
- **`CAST()`** и **`CONVERT()`** — используются для преобразования одного типа данных в другой.

### 5. Функции работы с NULL значениями

Помогают работать с `NULL` значениями, которые могут представлять отсутствующие или неопределённые данные
	
- **`ISNULL()`** или **`COALESCE()`** — возвращает первое ненулевое значение из списка аргументов.

### 6.Функции окон (Window functions)

Используются для выполнения операций над группой строк, но в отличие от агрегатных функций, они не сводят результат к одному значению
	
- **`ROW_NUMBER()`** — возвращает номер строки в рамках окна.
- **`RANK()`** — возвращает ранг строки.
- **`LAG()`** и **`LEAD()`** — возвращают предыдущее или следующее значение относительно текущей строки.

---
#операторы
# SQL операторы

В SQL операторы можно разделить на несколько категорий, каждая из которых соответствует определённому типу операций с данными. В контексте стандартов SQL, эти категории часто упоминаются как **DDL**, **DML**, **DCL** и **TCL**.

### 1. DDL (Data Definition Language) — Язык определения данных
Используются для создания и изменения структур баз данных, таких как таблицы, индексы, представления и т.д. Они определяют структуру базы данных.

- **`CREATE`** — создаёт новый объект в базе данных (например, таблицу, индекс)
	@: 
	CREATE TABLE employees ( 
		id INT PRIMARY KEY, 
		name VARCHAR(100), 
		salary DECIMAL(10, 2) 
	);
- **`ALTER`** — изменяет существующую структуру объекта (например, добавляет столбец в таблицу).
	@: ALTER TABLE employees ADD department VARCHAR(50);
- **`DROP`** — удаляет объект базы данных (например, таблицу)
	@: DROP TABLE employees;
- **`TRUNCATE`** — удаляет все строки из таблицы, но сохраняет её структуру
	@: TRUNCATE TABLE employees;

### 2. DML (Data Manipulation Language) — Язык манипуляции данными
Используются для работы с данными, хранящимися в таблицах. Они позволяют добавлять, изменять, удалять и выбирать данные

- **`SELECT`** — выбирает данные из одной или нескольких таблиц.
	@: SELECT * FROM employees;
- **`INSERT`** — добавляет новые строки данных в таблицу
	@: INSERT INTO employees (name, salary) VALUES ('John Doe', 50000);
- **`UPDATE`** — обновляет существующие данные в таблице
	@: UPDATE employees SET salary = 55000 WHERE name = 'John Doe';
- **`DELETE`** — удаляет данные из таблицы
	@: DELETE FROM employees WHERE name = 'John Doe';

### 3. DCL (Data Control Language) — Язык управления доступом
Используются для управления правами пользователей на объекты базы данных. С их помощью можно предоставлять или отнимать доступ к данным

- **`GRANT`** — предоставляет пользователю права на выполнение определённых операций
	@: GRANT SELECT, INSERT ON employees TO 'user1';
- **`REVOKE`** — отзывает права, ранее предоставленные пользователю
	@: REVOKE SELECT ON employees FROM 'user1';

### 4. TCL (Transaction Control Language) — Язык управления транзакциями
Используются для управления транзакциями в базе данных. Транзакция — это группа операций, которые либо выполняются все, либо не выполняется ни одна из них.

- **`COMMIT`** — фиксирует изменения, сделанные во время транзакции
	@: COMMIT;
- **`ROLLBACK`** — отменяет изменения, сделанные в текущей транзакции
	@: ROLLBACK;
- **`SAVEPOINT`** — устанавливает точку сохранения внутри транзакции, к которой можно вернуться с помощью `ROLLBACK`
	@: SAVEPOINT save1;

### 5. DQL (Data Query Language) — Операторы управления данными
Хотя формально DQL выделяют как отдельную категорию, в неё фактически включён только оператор **`SELECT`**, который используется для выборки данных

**Примеры использования:**
1. **DDL** — это когда вы создаёте таблицу или изменяете её структуру.
2. **DML** — это когда вы добавляете данные в таблицу, обновляете их или удаляете.
3. **DCL** — это когда вы управляете доступом к данным, предоставляя права пользователям.
4. **TCL** — это когда вы управляете транзакциями, которые могут включать несколько операторов DML, таких как `INSERT`, `UPDATE`, или `DELETE`, чтобы гарантировать целостность данных.

---
#транзакции
# Транзакции в SQL

**Транзакции в SQL** — это группа операций с базой данных, которые выполняются как единое целое. Если все операции в транзакции успешно завершены, изменения фиксируются в базе данных, если хотя бы одна операция завершилась ошибкой, все изменения откатываются, и база данных возвращается к исходному состоянию

**Транзакция** - это осуществление одного или нескольких изменений базы данных. Например, если вы создаете, обновляете или удаляете запись из таблицы, вы выполняете в этой таблице транзакцию. Важно контролировать транзакции, чтобы обеспечить целостность данных и обрабатывать ошибки базы данных.

Практически вы собираете множество SQL-запросов в группу, и они будут выполняться вместе как часть транзакции.
## Основные операторы, связанные с транзакциями:

- **BEGIN/START TRANSACTION**: начинает новую транзакцию.
    
- **COMMIT**: завершает транзакцию и фиксирует все изменения в базе данных.
    
- **ROLLBACK**: откатывает все изменения, сделанные в транзакции, если произошла ошибка или если нужно отменить транзакцию.
    
- **SAVEPOINT**: позволяет создать промежуточную точку в транзакции, к которой можно вернуться, не отменяя всю транзакцию.
    
- **RELEASE SAVEPOINT**: удаляет ранее созданную точку сохранения.
    
- **SET TRANSACTION**: устанавливает характеристики для текущей транзакции, например уровень изоляции.

@:
BEGIN TRANSACTION; 

INSERT INTO users (name, age) VALUES ('Alice', 30); 
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1; 

COMMIT;

**Нюансы:**
- Если ни `COMMIT`, ни `ROLLBACK` не будут выполнены, транзакция останется незавершенной, и система может зависнуть или выдать ошибку в будущем.
- После `COMMIT`, даже если вы создали несколько точек сохранения с `SAVEPOINT`, откат к этим точкам уже невозможен.
- Таким образом, после `COMMIT` транзакция считается завершённой, и любые изменения, сделанные в её рамках, невозможно отменить с помощью `ROLLBACK`.
- Если транзакция не явная, СУБД может автоматически выполнить `COMMIT` после каждой операции.

Все ли операции являются транзакциями? - Да, но только неявным образом
**Но**
- В большинстве баз данных простые операции, такие как `INSERT`, `UPDATE`, или `DELETE`, выполняются автоматически в рамках неявной транзакции. Это означает, что каждая операция автоматически завершается `COMMIT`-ом, даже если `BEGIN TRANSACTION` не был явно вызван.
- В случае явной транзакции вы используете команды `BEGIN TRANSACTION`, `COMMIT` и `ROLLBACK` для управления целостностью нескольких связанных операций. Только после выполнения `COMMIT` данные фиксируются в базе, и если что-то пошло не так, вы можете откатить транзакцию с помощью `ROLLBACK`.

---
# UNION и EXEPT

UNION - объединение нескольких запросов. Выводит поочередно результаты первого запроса, затем результаты второго
@:
Получить информацию о моделях производителей A и B.
SELECT * FROM product
WHERE maker = 'A'
*UNION*
SELECT * FROM product
WHERE maker = 'B';


EXEPT - разность (по типу NOT). Выводит результат за исключением выбранной категории в разделе EXEPT:
@:
Найти модели, которые не являются ПК
SELECT * FROM product
*EXCEPT*
SELECT * FROM product 
WHERE type = 'pc';

---
#union
# Оператор UNION

**Union** - оператор, служащий для объединения результатов выполнения SQL запросов
#### Особенности UNION
- По умолчанию убирает повторения в результирующей таблице (Для отображения с повторением есть необязательный параметр *ALL*)
- Объединение таблиц оператором UNION выполняется для таблиц никак не связанных, но со схожей структурой
*@:*
SELECT first_name, middle_name, last_name
FROM Student
**UNION**
SELECT first_name, middle_name, last_name
FROM Teacher;
#### Ограничения Union

1. Последовательность столбцов, тип данных столбцов, число столбцов объединяемых таблицы **должны совпадать**
2. Нельзя использовать подзапросы
3. В объединенных запросах нельзя использовать агрегатные функции

#### Схожие с UNION операторы

Существует два других оператора, чьё поведение крайне схоже с UNION:
	
- ***INTERSECT***. Комбинирует два запроса SELECT, но возвращает записи только первого SELECT, которые имеют совпадения во втором элементе SELECT.
- ***EXCEPT***. Комбинирует два запроса SELECT, но возвращает записи только первого SELECT, которые не имеют совпадения во втором элементе SELECT.

[SQL Academy](https://sql-academy.org/ru/guide/combining-queries)

---

#JOIN #LEFT_JOIN #RIGHT_JOIN #CROSS_JOIN
# JOIN

#### Соединение JOIN бывает:
	
- внутренним **INNER** (по умолчанию)
- внешним **OUTER**, при этом внешнее соединение делится на левое LEFT, правое RIGHT и полное FULL

## INNER JOIN

Внутреннее соединение — соединение, при котором находятся пары записей из двух таблиц, удовлетворяющие условию соединения, тем самым образуя новую таблицу, содержащую поля из первой и второй исходных таблиц.

![](Pasted%20image%2020241209111158.png)

## OUTER JOIN

Внешнее соединение может быть трёх типов: 
- левое (***LEFT***), 
- правое (***RIGHT***) 
- полное (***FULL***) (По умолчанию оно является полным)

Главным отличием внешнего соединения от внутреннего является то, что оно обязательно возвращает все строки одной (LEFT, RIGHT) или двух таблиц (FULL).

## LEFT OUTER JOIN

Соединение, которое возвращает все значения из левой таблицы, соединённые с соответствующими значениями из правой таблицы, если они удовлетворяют условию соединения, или заменяет их на NULL в обратном случае.

*SELECT ...* 
*FROM таблица_1 LEFT JOIN таблица_2 ON условие*

Результат запроса формируется так:

1. в результат включается внутреннее соединение (`INNER JOIN`) первой и второй таблицы в соответствии с условием;
2. затем в результат добавляются те записи первой таблицы, которые не вошли во внутреннее соединение на шаге 1, для таких записей соответствующие поля второй таблицы заполняются значениями `NULL`.

## RIGHT OUTER JOIN

Соединение, которое возвращает все значения из правой таблицы, соединённые с соответствующими значениями из левой таблицы, если они удовлетворяют условию соединения, или заменяет их на NULL в обратном случае. (Во многом аналогично LEFT JOIN)

## CROSS JOIN

Оператор перекрёстного соединения, или декартова произведения `CROSS JOIN` (в запросе вместо ключевых слов можно поставить запятую между таблицами) соединяет две таблицы. Порядок таблиц для оператора неважен, поскольку оператор является симметричным. Его структура:

*SELECT ...* 
*FROM таблица_1 CROSS JOIN таблица_2*

Результат запроса формируется так: каждая строка одной таблицы соединяется с каждой строкой другой таблицы, формируя  в результате все возможные сочетания строк двух таблиц. (Декартово произведение)


[Stepik](https://stepik.org/lesson/308886/step/3?unit=291012)
[SQL Academy](https://sql-academy.org/ru/guide/outer-join)

---




